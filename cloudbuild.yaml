steps:
  - name: $_NODE_IMAGE
    id: Build
    entrypoint: sh
    args:
      - -c
      - |
        npm ci && npm run build
  - name: gcr.io/cloud-builders/docker
    id: Tag and push image
    entrypoint: sh
    args:
      - -c
      - |
        docker build --build-arg CADDY_IMAGE=$_CADDY_IMAGE -t $_APP_IMAGE:$SHORT_SHA .
        docker push $_APP_IMAGE:$SHORT_SHA
  - id: Deploy to Cloud Run
    name: gcr.io/cloud-builders/gcloud
    entrypoint: bash
    args:
      - -c
      - |
        gcloud run deploy $_SERVICE --image $_APP_IMAGE:$SHORT_SHA --region us-central1
